# 🚗 AutoDrive 叫車完整流程指南

## 📱 **應用界面說明**

### **主頁面元素**
```
┌─────────────────────────────────────┐
│  乘客首頁        🕐 歷史   👤 個人  │
├─────────────────────────────────────┤
│                                     │
│         🗺️  地圖區域                │
│                                     │
│    📍 你的位置 (藍色標記)            │
│    🚗 附近車輛 (淺藍色圖標)          │
│    🚩 目的地 (綠色旗幟)              │
│                                     │
├─────────────────────────────────────┤
│  🔍 輸入目的地                      │
│  ─────────────────────────────      │
│                                     │
│  💰 預估金額：122292 micro IOTA     │
│     距離：約 5.12 公里               │
│     時間：約 10 分鐘                 │
│                                     │
│  🚙 [Honda Civic] [Tesla] [Toyota]  │
│     ← 水平滾動選擇車輛 →            │
│                                     │
│  [    🚗 叫車    ]  [ 🔄 刷新 ]     │
└─────────────────────────────────────┘
```

---

## 🎯 **完整叫車流程（6 步驟）**

### **步驟 1️⃣：註冊/登入**

#### 如果是新用戶：
1. 打開應用 → 選擇「乘客」角色
2. 點擊「註冊」
3. 填寫信息：
   ```
   用戶名：passenger_test
   密碼：12345678
   郵箱：passenger@test.com
   錢包地址：0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef
   ```
4. 點擊「註冊」按鈕

#### 如果已有帳號：
1. 選擇「乘客」角色
2. 輸入用戶名和密碼
3. 點擊「登入」

✅ **成功標誌**：進入地圖主頁面

---

### **步驟 2️⃣：查看地圖和附近車輛**

登入後自動顯示：
- 📍 **你的位置**：地圖中心的藍色標記
- 🚗 **附近車輛**：地圖上的淺藍色車輛圖標
- 📊 **底部面板**：搜索框和車輛列表

**系統自動執行**：
- 每 10 秒刷新一次附近車輛
- 顯示最多 12 輛可用車輛

✅ **成功標誌**：看到地圖上有車輛圖標

---

### **步驟 3️⃣：選擇目的地** ⭐ 重要

1. **點擊搜索框**「輸入目的地」

2. **輸入地點名稱**，例如：
   - `台北車站`
   - `西門町`
   - `信義區`
   - `松山區`
   - `大安區`

3. **點擊建議列表中的地點**
   - 會出現下拉建議
   - 點擊你想去的地點

4. **確認地圖變化**：
   - 🚩 目的地出現綠色旗幟標記
   - 📏 地圖自動調整視角顯示起點和終點

5. **查看預估信息**（自動顯示）：
   ```
   💰 預估金額：122292 micro IOTA
   📏 距離：約 5.12 公里
   ⏱️ 時間：約 10 分鐘
   ```

✅ **成功標誌**：
- 地圖上有綠色旗幟
- 底部顯示預估信息

---

### **步驟 4️⃣：選擇車輛** ⭐ 重要

1. **查看底部的車輛列表**
   - 水平滾動查看所有可用車輛
   - 每個卡片顯示：
     ```
     Honda Civic
     距離 1.2 km
     約 3 分鐘
     ```

2. **點擊一輛車**
   - 被選中的車輛會：
     - 背景變成綠色 🟢
     - 出現白色邊框
     - 文字變成黑色

3. **確認選擇**
   - 只能選擇一輛車
   - 點擊其他車輛會切換選擇

✅ **成功標誌**：有一輛車顯示為綠色

---

### **步驟 5️⃣：創建行程（叫車）** ⭐ 關鍵

#### 前置檢查：
- ✅ 已選擇目的地（有綠色旗幟）
- ✅ 已選擇車輛（有綠色卡片）

#### 執行叫車：
1. **點擊綠色的「叫車」按鈕**

2. **等待處理**（約 1-2 秒）
   - 按鈕顯示載入動畫
   - 狀態顯示「發送叫車請求...」

3. **查看結果**：

   **成功情況**：
   ```
   ✅ 叫車成功！行程 ID: 5
   ```
   - 自動跳轉到支付頁面
   - 顯示行程詳情和費用

   **失敗情況**：
   ```
   ❌ 叫車失敗：[錯誤信息]
   ```
   - 檢查錯誤信息
   - 可能原因：
     - 未選擇目的地
     - 未選擇車輛
     - 後端連接問題
     - 數據庫錯誤

✅ **成功標誌**：跳轉到支付頁面

---

### **步驟 6️⃣：查看行程歷史**

1. **點擊右上角的時鐘圖標 🕐**

2. **查看行程列表**：
   ```
   行程 #5
   狀態：已請求 (requested)
   車輛：Honda Civic
   起點：當前位置
   終點：台北車站
   費用：122292 micro IOTA
   時間：2025-10-08 15:47
   ```

3. **行程狀態說明**：
   - `requested` - 已請求（等待司機接單）
   - `matched` - 已匹配（司機已接單）
   - `accepted` - 已接受
   - `picked_up` - 已上車
   - `in_progress` - 行程中
   - `completed` - 已完成
   - `cancelled` - 已取消

✅ **成功標誌**：看到剛創建的行程

---

## 🔧 **後端 API 調用流程**

### **完整的 API 調用順序**：

```
1. 登入
   POST /api/v1/users/login
   → 獲取 access_token

2. 載入附近車輛（自動，每 10 秒）
   GET /api/v1/vehicles/available?lat=25.033&lng=121.5654&radius_km=4.0&limit=12
   → 返回車輛列表

3. 選擇目的地後，獲取行程預估
   POST /api/v1/trips/estimate
   Body: {
     "pickup_lat": 25.033,
     "pickup_lng": 121.5654,
     "dropoff_lat": 25.0478,
     "dropoff_lng": 121.5173,
     "passenger_count": 1
   }
   → 返回預估費用、距離、時間

4. 創建行程（點擊叫車）
   POST /api/v1/trips/request
   Body: {
     "pickup_lat": 25.033,
     "pickup_lng": 121.5654,
     "pickup_address": "當前位置",
     "dropoff_lat": 25.0478,
     "dropoff_lng": 121.5173,
     "dropoff_address": "台北車站",
     "passenger_count": 1,
     "preferred_vehicle_type": "sedan",
     "notes": "AutoDrive 乘客端叫車"
   }
   → 返回行程 ID 和詳情

5. 查看行程歷史
   GET /api/v1/trips/history
   → 返回所有行程記錄
```

---

## 🐛 **常見問題排除**

### **問題 1：看不到車輛**
**症狀**：底部車輛列表是空的

**解決方案**：
```bash
# 檢查數據庫中是否有車輛
docker-compose exec db psql -U autodrive -d autodrive_dev -c "SELECT vehicle_id, model, status FROM vehicles WHERE status = 'available';"

# 如果沒有車輛，運行初始化腳本
cd backend
python app/init_db.py
```

---

### **問題 2：創建行程失敗**
**症狀**：點擊叫車後顯示錯誤

**可能原因和解決方案**：

#### A. 數據庫 Schema 問題
```bash
# 檢查 trips 表是否有 escrow_object_id 欄位
docker-compose exec db psql -U autodrive -d autodrive_dev -c "\d trips" | grep escrow

# 如果沒有，添加欄位
docker-compose exec db psql -U autodrive -d autodrive_dev -c "ALTER TABLE trips ADD COLUMN IF NOT EXISTS escrow_object_id VARCHAR(66);"
```

#### B. 後端連接問題
```bash
# 檢查後端狀態
curl http://localhost:8000/health

# 查看後端日誌
docker-compose logs -f backend
```

#### C. 認證問題
- 確認已登入
- Token 可能過期，重新登入

---

### **問題 3：UI Overflow 警告**
**症狀**：底部出現黃黑條紋

**解決方案**：
- 已在最新代碼中修復
- 按 `r` 進行 Hot Reload

---

## 📊 **測試數據**

### **測試用戶**
```json
{
  "username": "test_passenger",
  "password": "12345678",
  "email": "test@example.com",
  "wallet_address": "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
}
```

### **測試目的地**
- 台北車站 (25.0478, 121.5173)
- 西門町 (25.0420, 121.5071)
- 信義區 (25.0330, 121.5654)
- 松山區 (25.0500, 121.5800)
- 大安區 (25.0267, 121.5436)

---

## 🎯 **快速測試流程**

```bash
# 1. 確保後端運行
curl http://localhost:8000/health

# 2. 啟動 Flutter 應用
./START_FLUTTER_IOS.sh

# 3. 在應用中：
#    - 註冊/登入
#    - 輸入「台北車站」
#    - 選擇建議
#    - 點擊一輛車
#    - 點擊「叫車」

# 4. 查看結果
#    - 應該跳轉到支付頁面
#    - 或查看錯誤信息

# 5. 如果失敗，生成錯誤報告
./REPORT_ERROR.sh
```

---

## 📞 **需要幫助？**

如果遇到問題：
1. 生成錯誤報告：`./REPORT_ERROR.sh`
2. 把報告內容貼給我
3. 或截圖給我看

我會幫你診斷和修復！🚀
