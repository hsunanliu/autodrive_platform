#!/usr/bin/env python3
"""
åˆ‡æ›åˆ°å¯¦éš›æ¨¡å¼çš„è¼”åŠ©è…³æœ¬
"""

import os
import asyncio
import httpx
import json
from getpass import getpass

class RealModeSetup:
    """å¯¦éš›æ¨¡å¼è¨­ç½®åŠ©æ‰‹"""
    
    def __init__(self):
        self.iota_node = "https://api.testnet.iota.cafe"
        self.config_file = "backend/app/config.py"
        self.env_file = ".env"
    
    async def check_wallet_balance(self, wallet_address: str) -> dict:
        """æª¢æŸ¥éŒ¢åŒ…é¤˜é¡"""
        try:
            payload = {
                "jsonrpc": "2.0",
                "id": 1,
                "method": "iota_getBalance",
                "params": [wallet_address]
            }
            
            async with httpx.AsyncClient() as client:
                response = await client.post(
                    self.iota_node,
                    json=payload,
                    headers={"Content-Type": "application/json"},
                    timeout=10.0
                )
                
                if response.status_code == 200:
                    result = response.json()
                    if "result" in result:
                        balance = int(result["result"])
                        return {
                            "success": True,
                            "balance_micro_iota": balance,
                            "balance_iota": balance / 1_000_000,
                            "sufficient": balance >= 1_000_000  # è‡³å°‘ 1 IOTA
                        }
                    else:
                        return {"success": False, "error": result.get("error", "Unknown error")}
                else:
                    return {"success": False, "error": f"HTTP {response.status_code}"}
        except Exception as e:
            return {"success": False, "error": str(e)}
    
    def validate_wallet_address(self, address: str) -> bool:
        """é©—è­‰éŒ¢åŒ…åœ°å€æ ¼å¼"""
        return (
            address.startswith("0x") and 
            len(address) == 66 and 
            all(c in "0123456789abcdefABCDEF" for c in address[2:])
        )
    
    def update_config_file(self, mock_mode: bool = False):
        """æ›´æ–°é…ç½®æ–‡ä»¶"""
        try:
            with open(self.config_file, 'r') as f:
                content = f.read()
            
            # æ›´æ–° Mock æ¨¡å¼
            if mock_mode:
                content = content.replace(
                    "MOCK_MODE: bool = True",
                    "MOCK_MODE: bool = True"
                ).replace(
                    "MOCK_MODE: bool = False", 
                    "MOCK_MODE: bool = True"
                )
            else:
                content = content.replace(
                    "MOCK_MODE: bool = True",
                    "MOCK_MODE: bool = False"
                )
            
            with open(self.config_file, 'w') as f:
                f.write(content)
            
            return True
        except Exception as e:
            print(f"âŒ æ›´æ–°é…ç½®æ–‡ä»¶å¤±æ•—: {e}")
            return False
    
    def update_env_file(self, wallet_address: str, private_key: str = None):
        """æ›´æ–°ç’°å¢ƒè®Šé‡æ–‡ä»¶"""
        try:
            # è®€å–ç¾æœ‰ .env æ–‡ä»¶
            env_vars = {}
            if os.path.exists(self.env_file):
                with open(self.env_file, 'r') as f:
                    for line in f:
                        line = line.strip()
                        if line and not line.startswith('#') and '=' in line:
                            key, value = line.split('=', 1)
                            env_vars[key] = value
            
            # æ›´æ–°éŒ¢åŒ…é…ç½®
            env_vars['PLATFORM_WALLET_ADDRESS'] = wallet_address
            if private_key:
                env_vars['PLATFORM_WALLET_PRIVATE_KEY'] = private_key
            env_vars['MOCK_MODE'] = 'false'
            
            # å¯«å›æ–‡ä»¶
            with open(self.env_file, 'w') as f:
                f.write("# AutoDrive Platform Environment Variables\n")
                f.write("# Generated by switch_to_real_mode.py\n\n")
                
                for key, value in env_vars.items():
                    f.write(f"{key}={value}\n")
            
            return True
        except Exception as e:
            print(f"âŒ æ›´æ–°ç’°å¢ƒæ–‡ä»¶å¤±æ•—: {e}")
            return False
    
    async def interactive_setup(self):
        """äº’å‹•å¼è¨­ç½®"""
        print("ğŸš€ AutoDrive å¯¦éš›æ¨¡å¼è¨­ç½®åŠ©æ‰‹")
        print("=" * 50)
        
        # 1. ç²å–éŒ¢åŒ…åœ°å€
        print("\nğŸ“ æ­¥é©Ÿ 1: éŒ¢åŒ…é…ç½®")
        while True:
            wallet_address = input("è«‹è¼¸å…¥å¹³å°éŒ¢åŒ…åœ°å€ (0x...): ").strip()
            
            if not wallet_address:
                print("âŒ éŒ¢åŒ…åœ°å€ä¸èƒ½ç‚ºç©º")
                continue
            
            if not self.validate_wallet_address(wallet_address):
                print("âŒ éŒ¢åŒ…åœ°å€æ ¼å¼ä¸æ­£ç¢º (æ‡‰ç‚º 0x é–‹é ­çš„ 66 ä½å­—ç¬¦)")
                continue
            
            break
        
        # 2. æª¢æŸ¥éŒ¢åŒ…é¤˜é¡
        print(f"\nğŸ” æ­¥é©Ÿ 2: æª¢æŸ¥éŒ¢åŒ…é¤˜é¡...")
        balance_result = await self.check_wallet_balance(wallet_address)
        
        if not balance_result["success"]:
            print(f"âŒ ç„¡æ³•æŸ¥è©¢éŒ¢åŒ…é¤˜é¡: {balance_result['error']}")
            print("è«‹ç¢ºèª:")
            print("  1. éŒ¢åŒ…åœ°å€æ­£ç¢º")
            print("  2. ç¶²çµ¡é€£æ¥æ­£å¸¸")
            print("  3. éŒ¢åŒ…å·²åœ¨ IOTA æ¸¬è©¦ç¶²ä¸Šæ¿€æ´»")
            return False
        
        balance_iota = balance_result["balance_iota"]
        print(f"ğŸ’° éŒ¢åŒ…é¤˜é¡: {balance_iota:.6f} IOTA")
        
        if not balance_result["sufficient"]:
            print("âš ï¸  éŒ¢åŒ…é¤˜é¡ä¸è¶³ (å»ºè­°è‡³å°‘ 1 IOTA)")
            print("è«‹è¨ªå• IOTA æ¸¬è©¦ç¶²æ°´é¾é ­ç²å–æ¸¬è©¦å¹£:")
            print("  https://faucet.testnet.iota.org/")
            
            continue_anyway = input("æ˜¯å¦ç¹¼çºŒè¨­ç½®? (y/N): ").strip().lower()
            if continue_anyway != 'y':
                return False
        
        # 3. ç§é‘°é…ç½® (å¯é¸)
        print(f"\nğŸ” æ­¥é©Ÿ 3: ç§é‘°é…ç½® (å¯é¸)")
        print("æ³¨æ„: ç§é‘°å°‡ç”¨æ–¼è‡ªå‹•ç°½ç½²äº¤æ˜“")
        print("å¦‚æœä¸æä¾›ï¼Œéœ€è¦æ‰‹å‹•ç°½ç½²æ¯ç­†äº¤æ˜“")
        
        include_private_key = input("æ˜¯å¦åŒ…å«ç§é‘°é…ç½®? (y/N): ").strip().lower()
        private_key = None
        
        if include_private_key == 'y':
            while True:
                private_key = getpass("è«‹è¼¸å…¥ç§é‘° (è¼¸å…¥æ™‚ä¸æœƒé¡¯ç¤º): ").strip()
                
                if not private_key:
                    print("âŒ ç§é‘°ä¸èƒ½ç‚ºç©º")
                    continue
                
                if len(private_key) < 32:
                    print("âŒ ç§é‘°é•·åº¦ä¸æ­£ç¢º")
                    continue
                
                break
        
        # 4. ç¢ºèªé…ç½®
        print(f"\nğŸ“‹ æ­¥é©Ÿ 4: ç¢ºèªé…ç½®")
        print(f"éŒ¢åŒ…åœ°å€: {wallet_address}")
        print(f"éŒ¢åŒ…é¤˜é¡: {balance_iota:.6f} IOTA")
        print(f"åŒ…å«ç§é‘°: {'æ˜¯' if private_key else 'å¦'}")
        print(f"æ¨¡å¼åˆ‡æ›: Mock â†’ å¯¦éš›")
        
        confirm = input("\nç¢ºèªæ‡‰ç”¨é€™äº›è¨­ç½®? (y/N): ").strip().lower()
        if confirm != 'y':
            print("âŒ è¨­ç½®å·²å–æ¶ˆ")
            return False
        
        # 5. æ‡‰ç”¨é…ç½®
        print(f"\nâš™ï¸ æ­¥é©Ÿ 5: æ‡‰ç”¨é…ç½®...")
        
        # æ›´æ–°ç’°å¢ƒæ–‡ä»¶
        if not self.update_env_file(wallet_address, private_key):
            return False
        print("âœ… ç’°å¢ƒè®Šé‡å·²æ›´æ–°")
        
        # æ›´æ–°é…ç½®æ–‡ä»¶
        if not self.update_config_file(mock_mode=False):
            return False
        print("âœ… é…ç½®æ–‡ä»¶å·²æ›´æ–°")
        
        # 6. å®Œæˆæç¤º
        print(f"\nğŸ‰ è¨­ç½®å®Œæˆ!")
        print("=" * 50)
        print("ä¸‹ä¸€æ­¥:")
        print("  1. é‡å•Ÿå¾Œç«¯æœå‹™: docker-compose restart backend")
        print("  2. é‹è¡Œæª¢æŸ¥: python check_interaction.py")
        print("  3. æ¸¬è©¦ç”¨æˆ¶è¨»å†Š (æœƒç”¢ç”ŸçœŸå¯¦äº¤æ˜“)")
        print("  4. ç›£æ§æ—¥èªŒ: docker-compose logs -f backend")
        
        print(f"\nâš ï¸  é‡è¦æé†’:")
        print("  â€¢ ç¾åœ¨æ¯æ¬¡æ“ä½œéƒ½æœƒæ¶ˆè€—çœŸå¯¦çš„ Gas è²»ç”¨")
        print("  â€¢ è«‹ç›£æ§éŒ¢åŒ…é¤˜é¡ï¼ŒåŠæ™‚è£œå……æ¸¬è©¦å¹£")
        print("  â€¢ å¦‚éœ€åˆ‡å› Mock æ¨¡å¼ï¼Œé‹è¡Œ: python switch_to_real_mode.py --mock")
        
        return True
    
    def switch_to_mock(self):
        """åˆ‡æ›å› Mock æ¨¡å¼"""
        print("ğŸ”„ åˆ‡æ›å› Mock æ¨¡å¼...")
        
        if self.update_config_file(mock_mode=True):
            print("âœ… å·²åˆ‡æ›å› Mock æ¨¡å¼")
            print("é‡å•Ÿæœå‹™: docker-compose restart backend")
            return True
        else:
            return False

async def main():
    """ä¸»å‡½æ•¸"""
    import sys
    
    setup = RealModeSetup()
    
    if len(sys.argv) > 1 and sys.argv[1] == "--mock":
        setup.switch_to_mock()
    else:
        await setup.interactive_setup()

if __name__ == "__main__":
    asyncio.run(main())